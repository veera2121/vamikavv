<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Product Reviews</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    padding: 20px;
  }

  .review-card, .review-box {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.08);
  }

  .review-card h2 {
    text-align: center;
    margin-bottom: 10px;
  }

  .stars span {
    font-size: 24px;
    color: #ddd;
    cursor: pointer;
  }

  .stars span.active {
    color: #ffc107;
  }

  button {
    padding: 12px;
    width: 100%;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    cursor: pointer;
  }

  button:hover {
    background: #43a047;
  }

  .review-header {
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    margin-bottom: 8px;
  }

  .review-text {
    color: #555;
  }

  .no-reviews {
    text-align: center;
    color: #888;
    font-style: italic;
  }
</style>
</head>
<body>

<!-- Review Form -->
<div class="review-card">
  <h2>Write a Review</h2>
  <input type="text" id="name" placeholder="Your Name" required>
  
  <div class="stars" id="stars">
    <span data-value="1">★</span>
    <span data-value="2">★</span>
    <span data-value="3">★</span>
    <span data-value="4">★</span>
    <span data-value="5">★</span>
  </div>
  <input type="hidden" id="rating" required>

  <textarea id="review" placeholder="Write your review..." required></textarea>

  <button id="submitBtn">Submit Review</button>
</div>

<!-- Reviews Display -->
<section id="reviews-section">
  <h3 style="text-align:center;">Customer Reviews</h3>
  <div id="reviewsList"></div>
</section>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const supabase = window.supabase.createClient(
    "https://ukjnvxxobmnboohrucqo.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVram52eHhvYm1uYm9vaHJ1Y3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3MDQ1NzgsImV4cCI6MjA4MTI4MDU3OH0.8RE9DGlVMWsr_umCaETbhuBDII111PcFXBTddFLmMUE"
  );

  const params = new URLSearchParams(window.location.search);
  const productId = params.get("product_id");

  const stars = document.querySelectorAll("#stars span");
  const ratingInput = document.getElementById("rating");

  // Star rating selection
  stars.forEach(star => {
    star.addEventListener("click", () => {
      const value = star.dataset.value;
      ratingInput.value = value;
      stars.forEach(s => s.classList.toggle("active", s.dataset.value <= value));
    });
  });

  // Submit review
  document.getElementById("submitBtn").addEventListener("click", async () => {
    const name = document.getElementById("name").value.trim();
    const rating = Number(ratingInput.value);
    const review = document.getElementById("review").value.trim();

    if (!name || !rating || !review) {
      alert("Please fill all fields and select a rating.");
      return;
    }

    if (!productId) {
      alert("Product ID missing in URL!");
      return;
    }

    const { error } = await supabase.from("reviews").insert([{
      product_id: productId,
      customer_name: name,
      rating: rating,
      review: review
    }]);

    if (error) {
      console.error(error);
      alert("Failed to submit review: " + error.message);
    } else {
      alert("Review submitted!");
      document.getElementById("name").value = "";
      document.getElementById("review").value = "";
      ratingInput.value = "";
      stars.forEach(s => s.classList.remove("active"));
      loadReviews(); // refresh reviews instantly
    }
  });

  // Load reviews
  async function loadReviews() {
    const list = document.getElementById("reviewsList");
    list.innerHTML = "";

    if (!productId) {
      list.innerHTML = "<p class='no-reviews'>Product ID missing</p>";
      return;
    }

    const { data, error } = await supabase
      .from("reviews")
      .select("customer_name, rating, review, created_at")
      .eq("product_id", productId)
      .order("created_at", { ascending: false });

    if (error) {
      console.error(error);
      list.innerHTML = "<p class='no-reviews'>Failed to load reviews</p>";
      return;
    }

    if (!data || data.length === 0) {
      list.innerHTML = "<p class='no-reviews'>No reviews yet</p>";
      return;
    }

    data.forEach(r => {
      list.innerHTML += `
        <div class="review-box">
          <div class="review-header">
            <span class="review-name">${r.customer_name}</span>
            <span class="review-stars">${"★".repeat(r.rating)}</span>
          </div>
          <div class="review-text">${r.review}</div>
        </div>
      `;
    });
  }

  // Load reviews on page load
  loadReviews();
</script>
</body>
</html>
